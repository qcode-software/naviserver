======================================
NaviServer 4.99.6, released 2014-06-29
======================================

Changes relative to 4.99.5
    198 files changed, 4972 insertions(+), 2657 deletions(-)

New Features/Performance Improvements:

    * Added support for delivering static gzipped content 
      via ns/fastpath.
      NaviServer allows now deliver gzipped content for static files
      in cases the client requests for this. The gzipped files 
      are stored
      statically in the file system like the unzipped content. Therefore
      the file delivery of gzipped content can be performed without 
      runtime penalty. NaviServer compares the time stamps of the
      compressed and uncompressed content. If the time-stamp of the
      uncompressed content is changed, NaviServer refreshes the
      compressed content automatically.

      The static gzip delivery is controlled over the following
      configuration parameters:

	- parameter "gzip_static" for "ns/fastpath" (default false)

	  Send the gzipped version of the file if available and the
  	  client accepts gzipped content. When a file path/foo.ext is
  	  requested, and there exists a file path/foo.ext.gz, and the
  	  timestamp of the gzipped file is equal or newer than the
  	  source file, use the gzipped file for delivery.

	- parameter "gzip_cmd" for "ns/fastpath" (default "")

  	  Command for zipping files in case the (static) gzipped
	  version of the file is older than the source. The command is
	  just used for re- gzipping outdated files, it does not
	  actively compress files, which were previously not
	  compressed (this would be wasteful for e.g.  large tmp
	  files, there is not cleanup, etc.). If this parameter is not
	  defined, outdated gzipped files are ignored, and a warning
	  is written to the error.log. Example setting: 
          "/usr/bin/gzip -9".

        - parameter "gzip_refresh" (default false)

          When the parameter is set to true and the modification time
          of the compressed file is older than the modification time
          of the source then refresh the compressed file automatically
          with the command "::ns_gzipfile source target". When this
          parameter is not defined (or the refresh cmd fails),
          outdated gzip-ed files are ignored, a warning is written to
          the error.log and the content is delivered uncompressed.

      The content is never delivered gzipped on range requests. 



    * Security improvements:

      - Prevent potential HTTP response splitting attack: all response
        header fields are sanitized to avoid injection of header file
        contents potentially leading to HTTP response splitting attacks.

      - Improved nsssl driver
        * provide forward secrecy and DH key exchange with precompiled
          defaults
        * support elliptic curve cryptography (ECDH)
        * deactivated SSLv2

      - By using parameter "extraheaders" (see below) in nsssl one can
	activate HTTP Strict Transport Security (HSTS) for nsssl (see
	https://bitbucket.org/naviserver/nsssl/)

      - The sample configuration of nsssl leads to a "A+" rating from
        SSL labs.


    * Mime-types overhaul:
       
      - NaviServer supports now the all mimetypes as defined via RFCs,
	W3C and IANA
      - Some incorrect mimetypes are fixed
      - scripted mimetype definitions produce warnings on overwriting
        of mimetypes and on useless definitions.


   * Modules update:

      - include nsdbi* in packaged module tar file
      - extended options in ns_dbi for dbi_rows
      - added compatibility to nsdns for new versions of DiG (9.10.*)
      - fixes for nsudp (HTTP over UDP), nsdbpg, nszlib, 
        nssmtpd, nsstats


Bug Fixes:

    * Tcl argument list parser: The old implementation could lead to
      crashes when Tcl_Objs where shared and the internal validation
      of the internal representation failed.

      Tcl_GetIndexFromObj() validates internal representations based
      on the pointer of the base string table, which works only
      reliably with static string tables. Since command definitions
      contain non-static fields (which cannot be determined at compile
      time) NaviServer can't use static string tables, but uses
      stack-allocated string tables for command definitions. This can
      lead to mix-ups for shared Tcl_Objs (keeping base of string
      table and index) in case two string tables are at the same
      position on the stack. As a consequence, the internal
      representation with a potentially wrong index is reused,
      leading to potential crashes. Now. the caching is only allowed
      for non-shared Tcl_Objs.

    * Module loading: Previous versions of NaviServer loaded always
      "global modules" after per-server modules (and after blueprint
      generation).  If e.g. a database modules was loaded globally, it
      was not possible to refer to its defined command from the
      blueprint. Now, just the loading of network modules happens in
      the strict old order.

    * Ns_CacheUnsetValue() is now more robust against code, where
      freeProc calls a ns_cache operation (such as
      e.g. nsdbipg). Before that modification, double free operations
      were possible when the cache was pruned.  

    * Make sure to initialize all members of Ns_DriverInitData to zero

    * sockcallback.c: fix size of reallocation unit (many thanks to
      Wolfgang Winkler for pointing this out)

    * tclmisc.c: fix incorrect type for allocation unit (sha context
      instead of md5 context)

    * Fix flag settings in ns_adp_parse

    * Fix clock ensemble oddity in blueprint (error message: Error:
      time zone ":Tcl/Localtime" not found; many thanks to 
      David Osborne)

    * Save Tcl interpreter aliases and ensembles in blueprint (Many
      thanks to Jeff Rogers)

    * Fix generation of documentation: dtplite from tcllib 1.15 does
      not allow spaces in "titles" of manpages. Fix all manpages, such
      that build-doc works again.


Documentation improvements:

    * Doc page for ns_return: added section for describing 
      fastpath configuration

    * Document that "ns_conn compress 0" can deactivate compression

    * Updated documentation of deprecated commands in the source

    * Fixed/updated/extended various man pages such as ns_tmpnam,
      ns_getform, ns_set

    * Removed obsolete commands from the documentation (ns_set with
      -persist, -shared, ns_share)
        

Tcl API Changes:

    * ns_setcookie, ns_getcookie ns_deletecookie:

      - ns_setcookie, ns_deletecookie: added flag "-replace" to
        replace already issued cookie requests in output headers; the
        same option is used in OpenACS.

      - ns_setcookie: added option "-discard" as specified in RFC 2965

      - ns_getcookie: added option ?-include_set_cookies bool? to
        search cookies being set as well (from output headers); the
        same option is used in OpenACS.
 
    * ns_http: 

      - Added flags "-file /varName/" and "-spoolsize /int/" to
        "ns_http wait". If the content of the obtained file is larger
        or equal than spoolsize, it is spooled to temp file,
	and the name of the temp file is returned in the 
        variable provided by "-file". These options make it 
        possible to retrieve also large
	content (e.g. video files) via ns_http without bloating memory

      - Additional parameter "-decompress" for "ns_http wait" to
	compress the result on the fly (incrementally) in 
        case it is content encoding is "gzip"

    * ns_time: add option "ns_time format" to print a time 
      in the sec:usec format in secs in a decimal dot notation

    * Mark ns_tmpnam as deprecated since it uses an 
      deprecated C-library function (use ns_mktemp instead)

    * Allow "ns_mktemp" to be called without template 
      (makes migration from ns_tmpnam simpler)

    * Mark ns_connsendfp as deprecated (it was already 
      documented as deprecated, superseded by ns_writefp)


C API Changes:
    None

Incompatible API Changes:
    None

Configuration Changes:

    * New parameter "extraheaders" to drivers (e.g. nssock,
      nsssl). This feature allows an admin to specify extra reply
      headers sent back on every request. By using this feature, one
      can activate for example HTTP Strict Transport Security (HSTS)
      for nsssl (see https://bitbucket.org/naviserver/nsssl/)

    * Update man pages and sample config files


Command Line Changes:
    None

Code Changes:
    * Added compatibility with OpenSolaris (e.g. OmniOS).

    * Code Cleanup
      - reduce variable scopes to improve locality
      - Get rid of CVS variables
      - make test for byte-array safe for changes introduced in 
        Tcl 8.6 and back-ported to Tcl 8.5 
        (see e.g. http://core.tcl.tk/tcl/info/91be696bf3)
      - defined new macro NS_GNUC_DEPRECATED_FOR() to be able to provide
	replacement hint and use it where appropriate
      - improve error message

    * Test environment:
      - nstest::http: added flag "-getmultiheaders" to return all
	header fields (multiset) with the specified name

    * Build environment:
      - use recommended autoconf constants quoting
      - deactivate AM_* macros (get rid of warnings), since 
        these are not used by autogen.sh
      - replace obsolete macro AC_TRY_RUN, AC_TRY_LINK
      - use recent version of install-sh and tcl.m4
      - additional make target: cppcheck

   * Extended regression test

======================================
NaviServer 4.99.5, released 2013-05-25
======================================

New Features:

    * New connection thread architecture:
      - Introduced connection thread queues for better control over
        connection threads and to reduce queuing operations for
        handing requests from the driver to the connection threads.

    * Support for improved TCP socket option handling 
      (when supported by the OS);
       - use TCP_FASTOPEN (when deferaccept is configured)
       - Adding TCP option "nodelay" for nssock on operating 
         systems that do not use this by default (such as Linux)
       - Use TCP_CORK to optimize TCP_PACKAGE size on machines where
         this is available.

    * Improved asynchronous request handling and log file writing to
      reduce latencies and improve robustness

       - Asynchronous HTML streaming via writer threads to reduce
         connection thread blocking time for slow delivery lines.
       - New asynchronous log file writer to write access.log
         and error.log without blocking - configurable

    * Better scalability by reducing busiest lock contention and
      finer lock granularity (see below).

    * Improved introspection commands:
      - Report more detailed timing information and request statistics
        via "ns_server ?-server s? ?-pool p? stats". The command
        returns accept-times, queue-times, filter-times and run-times
        per server and pool.
      - Report OS-level thread ID via "ns_info threads" when supported
        from the OS (currently just Linux). This information is used by
        nsstats.tcl to report e.g. system time and user time per thread.
      - New subcommand "ns_conn clientdata" to query or set client data
        (used e.g in ns_writer list)
      - Added ns_fastpath_cache_stats to obtain usage info from the
        fastpath cache

    * Support for marking scripted and C-implemented Tcl-commands 
      as deprecated.



Performance Improvements:

    * Server lock to pool lock in most cases
    * Lazy init of zlib (mostly reduction in memory consumption)
    * Allow delivery of mmapped files via writer without the need of copying content.
    * Introduce separate locks for waiting queue (wqueue) and thread queue
      (tqueue) per pool. In classical naviserver there is was a single poll lock
      (covering all pools) used. The change leads to much finer lock
      granularity in improves scalability.
    * Added async disk writer to reduce request latencies due to file system latencies. 
      Now used optionally for access log and error-log.
    * Use GetSection() instead of Ns_ConfigCreateSection() in ConfigGet().
      This is faster and removes the need for the most-frequently used mutex lock
      in naviserver, namely "nsd:conf".
    * Compiler optimizations for branch prediction - likely(),unlikely() macros.  
    * Improved concurrency in writer threads by supporting asynchronous 
      parial writes.


Bug Fixes:

    * Do not save variables of the toplevel namespace into the blueprint. 
      OpenACS had with this a problem, since the database handles are managed via 
      global variables, which is solved by this modification.
    * ns_eval -sync syntax.
    * Fixed all known range request bugs from regression test.
    * Fix output for "ns_server active|queued|all"
    * ns_server stats and in ns_server connections to be per server.
    * Fix length computation in "ns_writer submitfile" when offset is specified
    * Fix thread safety of "nswriter list".
    * Simplified driver logic and fixed bad interaction with nsssl,
      which used non-blocking sockets, but declared itself as a non-async
      driver). Fixed potential bug for partial reads in header parsing
      (string comparison could read past available bytes, pick up values
      from previous requests). 
    * Increase static buffer size to prevent SSL from stalling.
    * Fix a bug showing up with nsssl (a driver has no NS_DRIVER_ASYNC flag set), 
      where pollin says that data is available, but the read returns no data 
      and leads to a busy loop.
    * Fix bug in rolling access log when rollfmt is specified. Previously 
      the log file was closed but not reopened, log data was lost.
    * Protect against a bug in Tcl, when several threads are created
      concurrently via Tcl_CreateInterp()


Documentation improvements:

    * Updated/completed/added documentation (ns_conn, ns_http and
      friends, ns_writer, ns_register, ns_register_op, ns_return, ...)

    * Remove man pages for non-existing commands and half written man
      pages.

    * Updated documentation in configuration files

    * Added sample configuration file for OpenACS


Tcl API Changes:

    * New and modified commands/subcommands:

      - nsv_get: added optional argument ?varName? to nsv_get to
        obtain compatibility with tsv::get in the Tcl thread
        library. This option allows an atomic test + get operation,
        avoiding unsafe nsv_exists following by nsv_get.

          nsv_get /array/ /key/ ?/varName/?

      - Obtain a value from the cache 
        (similar to nsv_get)

          ns_cache_get /cache/ /key/ ?/varName/?
        
      - Write a notice to the error.log when this command 
        is used 

          ns_deprecated ?/alternative/? ?/explanation/?

      - Change server settings on the fly:

          ns_server ?-server /server/? ?-pool /p/? maxthreads ?/value/?
          ns_server ?-server /server/? ?-pool /p/? minthreads ?/value/?

      - The following commands can return now server-specific
        results, when "-server ..." is used:

          ns_server ?-server /server/? filters
          ns_server ?-server /server/? pagedir
          ns_server ?-server /server/? requestprocs
          ns_server ?-server /server/? tcllib
          ns_server ?-server /server/? traces
          ns_server ?-server /server/? url2file


      - The following commands can return now server-specific
        and pool-specific results:

          ns_server ?-server /server/? ?-pool p? active
          ns_server ?-server /server/? ?-pool p? all
          ns_server ?-server /server/? ?-pool p? queued
          ns_server ?-server /server/? ?-pool p? connections
          ns_server ?-server /server/? ?-pool p? maxthreads ?value?
          ns_server ?-server /server/? ?-pool p? minthreads ?value?
          ns_server ?-server /server/? ?-pool p? stats
          ns_server ?-server /server/? ?-pool p? threads
          ns_server ?-server /server/? ?-pool p? waiting

      - Return number of requests, number of spools and number of
        requests added to the waiting queue plus cumulative times to
        serve requests.

          ns_server ?-server /server/? ?-pool /p/? stats

      - Query for the current connection, whether
        the requestor accepts zipped results
        
          ns_conn zipaccepted

      - Return for the current connection the 
        connection pool

          ns_conn pool
 
      - Query or set for the current connection the client data.  The
        client data is provided by the application and is potentially
        passed to different threads and can be used to establish the
        context with the connection thread. For example, the writer
        thread outputs the client data when listing running connections
        (one can determine e.g. which user has initiated the delivery,
        etc.).

          ns_conn clientdata

      - Query or modify the size limit of files being delivered
        via the writer threads

          ns_writer size /driver/ ?/value/?

      - Query or modify the configuration parameter
        writerstreaming that controls streaming HTML
        output via writer threads
  
          ns_writer streaming /driver/ ?/value/?

      - Allow to restrict the output of "ns_writer list"
        to list only requests from a particular (virtual) server

          ns_writer list ?-server /server/?

      - The output of "ns_writer list" now contains the start time of
        the initiating request, the name of the thread, driver, the
        ip-address of the requestor, the file descriptor, the
        remaining size and the bytes already sent, and the client data
        as provided via [ns_conn clientdata].

      - Determine the section in the configuration for a driver
        in the configuration file

          ns_driversection ?-driver /drv/? ?-server /server/?


    * Deprecated commands/subcommands:


      - ns_httpget, ns_httppost and ns_httpopen are deprecated (use
        ns_http instead)

      - "ns_info platform" is deprecated; use $::tcl_platform(platform) instead.
        "ns_info winnt" is deprecated; use $::tcl_platform(platform) instead.

      - ns_register_adptag is deprecated - use ns_adp_registerscript instead.

      - ns_adp_registertag is deprecated - use ns_adp_registeradp instead.

      - The following commands are deprecated

          ns_info filters
          ns_info pagedir
          ns_info pageroot
          ns_info requestprocs
          ns_info tcllib
          ns_info traces
          ns_info url2file

        and defined the following commands instead:

          ns_server ?-server /server/? filters
          ns_server ?-server /server/? pagedir
          ns_server ?-server /server/? requestprocs
          ns_server ?-server /server/? tcllib
          ns_server ?-server /server/? traces
          ns_server ?-server /server/? url2file

      - ns_server - passing pool as 2nd argument is deprecated.
        new option serverdir returns the base directory. Using 
        instead the explicit options
          "ns_server ?-server /server/? serverdir" 
     
      - "ns_server keepalive" is deprecated;
        use "ns_conn keepalive" instead


C API Changes:
    * Ns_OptionConverter: added Ns_OptionServer to convert string to
      existing server.  Extended option parser to allow options at the
      end of a command

    * New function NsWakeupDriver(); used in queue to signal
      conditions to the driver, when we might have to recreate
      threads.

    * New function NsWakeupConnThreads(ConnPool *poolPtr) to wake up
      every idle conn thread during shutdown.


Incompatible API Changes:
   * ns_setexpires takes single argument for seconds to calculate
     Expires header.  Passing conn no longer supported (was deprecated).

Configuration Changes:
    * Provided sample OpenACS config file openacs-config.tcl.

    * New boolean parameter "writerstreaming" for drivers to
      activate/deactivate streaming of HTML output via writer thread.

    * New boolean parameter logpartialtimes true" for section
      ns/server/${server}/module/nslog: Include a high-resolution
      start time and partial request durations (accept, queue, filter,
      run) in the access log.

    * New integer parameters "lowwatermark" and "highwatermark" in
      section ns/server/${server} for controlling connection thread
      creation:

        ns_param lowwatermark 10  ;# Create additional threads when 
                                  ;# the queue is more than 10% full
        ns_param highwatermark 80 ;# Allow concurrent when queue is 
                                  ;# more than 80% full. Specifying 
                                  ;# 100% effectively disables this.

    * New boolen parameter asynclogwriter under ns/parameter to
      turn on/off asynchronous writes to access log and error log

    * Obsolete flushcontent parameter is no longer supported.

Command Line Changes:

    * Allow calls for "nsd -c" without config files.  

        $ /usr/local/ns/bin/nsd  -c

    * Allow specification of environment variable NAVISERVER to point
      to the naviserver home directory (for e.g. log file
      directories), otherwise determined by the location of the nsd
      binary. Examples:

        $ NAVISERVER=/usr/local/ns/ ./nsd/nsd  -c


Code Changes:
    * Moved statistics structure from NsServer to ConnPool to track
      per-pool usage. Added member poolPtr to Conn for easy association.

    * Defined new C function Ns_LogDeprecated() for handling deprecated
      messages for tcl-level defined commands.

    * Standardize printing of timings (get rid of stupid $sec.$microsecs,
      where 1.2 means 1.000002 secs).

    * Extend interface of NsWriterQueue() to accept iovec & nbufs
      (as required by Ns_ConnSend()). This saves an unneeded copy of the
      send data.

    * Reduce number of (used) API calls by favoring iovec interface.

    * Handle partial low-level writes correctly by allowing partial
      writes at the driver level.

      - The old SockSend() is now implemented using of nssock.sendProc
        and performs partial writes on non-blocking sockets.

      - Ns_SockSendBufs() delivers all iovec bufs like before but now
        calls NsDriverSend() instead of the direct SockSend().

      - Ns_ConnSend() calls Ns_SockSendBufs() instead of NsDriverSend() in
        cases, where the writer thread is not used.

      - Ns_SockSendBufs() calls NsDriverSend() instead of SockSend()

      - Ns_SockSendFileBufs() calls NsDriverSend() instead of
        Ns_SockSendBufs()

      Further changes:

      - Group fields in WriterSock to separate concern of file-spooling and
        memory based requests.

      - Factor out WriterSend() from DriverThread() to improve readability
        and locality

    * use scatter/gather interface for writer instead of the char* interface

    * Generalized option parser from ns_server and used in
      ns_urlencode and ns_urldecode to get rid of the potential crash
      due to non-static strings in Tcl_GetIndexFromObjStruct().

    * Update to TEA 3.9, rename configure.in to configure.ac as
      suggested by the auto-tools warning

    * Provide better error message when subcommand of "ns_server" not
      found.

    * Add lookup for server in NsTclServerObjCmd()

    * Make Ns_ObjvTable static where possible

    * Drop LogToAsyncFile and use NsAsyncWrite in LogToFile.  Async
      log file writing can be switched on/off by configuring the async
      log writer.

    * Remove spread factor, which is not needed due to connection
      thread queue

    * use gettimeofday() if available instead of the rount trip to tcl

    * Adjusting server exit to new infrastructure; new function
      NsWakeupConnThreads(ConnPool *poolPtr) to wake up every idle
      conn thread during shutdown.

    * Report error message in sock accept, if the errno is different
      from EAGAIN.

    * Let Ns_ConnSend() use the writer thread to deliver adp-content
      etc. without blocking a connection thread. This improves the request
      latency and avoids potential slow-delovery DOS attacks.
      
    * Extend the interface of SockWriterRelease() to contain the
      queue. SockWriterRelease() manages now the queue entries as seen
      e.g. by "nswriter list".  Handle POLLHUP in writer thread
      explicitly.

    * Delegate close() operations from writer thread to driver thread via
      NsSockClose().

    * Added support for SO_ACCEPTFILTER for machines having no
      TCP_DEFER_ACCEPT

    * Extending buffer size when sending files via writer thread from
      4KB to 16KB.

    * Replaced unsafe system calls with safe ones (e.g. mktemp() by mkstemp())

    * Improved code quality with static analyzer and valgrind

    * Extended regression test


======================================
NaviServer 4.99.4, released XXXX-XX-XX
======================================

New Features:

    * Less eager thread creation short request peaks. Naviserver tended
      to create too many threads in situation of short bottlenecks (e.g.
      file system latencies). This can reduce resource consumption on
      larges sites significantly.

    * New threads are added to the waiting queue in an already warm
      state.  Previously, threads we created in one step and the
      initialization of thread blocked the first request added to the
      thread. "minthreads" controls the number of warm threads kept
      around.

    * Improved cache statistics: added "saved", expressing cumulative
      saved time from "ns_cache_eval". The reporting of theses
      statistics as updated as well in the add-on package nsstats.

    * Improved locking statistics: added "total_waiting_time" and
      "max_waiting_time" to the mutex monitoring statistics. The
      reporting of theses statistics as updated as well in the add-on
      package nsstats.

    * Made upload progress management compatible with usual 
      tracking conventions by using the query parameter "X-Progress-ID"
      if present (as used in nginx, lighttpd and by apache (mod_passenger)).

    * Added support for chunked encoding for uploads (as used e.g. in WEBDAV
      PUT requests from Mac OS X Finder).

    * Added small compatibility layer for providing Aolserver compatibility
      (e.g. support "ns_cache eval" as well as "ns_cache_eval"); the layer
      is designed to be sufficient for OpenACS.

    * Improve concurrency on writing on access logs. File system latencies
      can block the full server, the change improves the situation.

    * Added [ns_thread stackinfo] to obtain stack size and usage from the 
      current thread.

    * Add option "-exact" to "ns_cache_keys" to enable exact lookups (also 
      when glob characters are used in keys)

    * Provided constat time lookup for [ns_cache_keys /cache/
      /pattern/], when "pattern" contains no glob characters

    * Added .htaccess mode for nsperm module. Similar to Apache but
      only to allow access. This is disabled by default, can be
      enabled in the ns/server/servername/module/nsperm section. Doc
      is updated. In this version only current directory is checked
      for .htaccess file.

    * New lazy Tcl interpreter initialization option. Saves memory and speeds
      initialization of interp on first use by defining procs on-demand.
      See: tcl/lazyloader parameter below.

    * New module nsproxy executes Tcl scripts via pool of external
      processes. Useful to keep buggy/non-thread-safe code isolated from
      main server process. See also: ns_job.

    * Log filter callbacks (Tcl and C) may be added to the error log stream
      to handle particular kinds of log messages by e.g. logging to a separate
      file.

    * Error logging may now be disabled/enabled at runtime with the
      ns_logctl command.

    * User-defined named log severities may be created using the ns_logctl
      command. These may be enabled/disabled individually, at runtime, unlike
      the old numeric user-levels.

    * New limits feature. Connection limits can be bundled together into a
      named set of limits and then applied to a subset of the URL
      hierarchy. The max number of connection threads running and waiting to
      run a URL, the max upload file size, and the max time a connection
      should wait to run are all configurable. See ns/limits parameters below.

    * ns_cache_create now takes a -maxentry switch limits the max size of an
      entry allowed into the cache to prevent wasteful cache flushes.

    * ns_cache_create now takes a -timeout switch which is the default timeout
      for one thread to wait for another to complete an ns_cache_eval command,
      if the -timeout switch is not given to the ns_cache_eval command itself.

    * Time values passed to commands such as the -timeout switch of
      ns_cache_eval now distinguish between an absolute time in the future and
      an offset from the current time. A heuristic is used: large values are
      absolute times in the future.

    * A new [ns_cache_eval -force ...] switch replaces any existing cached value
      whether it is up to date or not.

    * A new ns_cache_stats -contents switch dumps the expire and size of each
      entry in the cache cache. Useful when developing / testing to check
      utilisation.

    * The new [ns_conn keepalive ?bool?] sub-command disables or requests
      keepalive behavior for the current connection.

    * ns_getcsv now takes a -delimiter switch.

    * ns_parseargs: default values can now be specified with in the form 
      {[..]} to cause evaluation, like ns_parseargs {-flag {[script]}} $args ...

    * Commands which timeout now set a NS_TIMEOUT Tcl error code, which if not
      caught is reported as an HTTP 503 Unavailable response.

    * Handle png images, as well as existing gif and jpg with new ns_img*
      commands.

    * New [ns_mutex eval script] to safely handle unlocking on error.

    * Thread commands now takes names as well as thread-object references.

    * New options jobsperthread and jobtimeout for ns_job command to perform
      automatic job threads exit in case of idle or max number of jobs reached

    * Updated ns_perm module to support missing checkpass and sepass commands

    * ns_http was ported from Aolserver 4.5 and uses new task API

    * ADP parser was ported from AS 4.5 and also used for processing .tcl files

    * New option acceptsize for driver to tell how many connection can be accepted at once,
      this improves performance significantly in case of large number of incoming connections

    * New Ns_Sls* and ns_sls commands supporting socket-local-storage (data which persists for 
      the lifetime of an open TCP connection)

    * ns_httpget now supports chunked encoding in results

    * ns_return etc. will now gzip the body content, if that option is enabled.

    * Static files can now be sent using the OS native sendfile() on
      supported platforms (currently Linux).

    * ns_unregister_op is now the correct way to unregister procs, adp, and tcl
      pages. (The older names are kept around for backwards compat.)

    * NaviServer now builds on Win32 using the standard configure scripts and
      the MingWin32 compiler.

    * New command ns_mutex trylock which works similar to the same C API function

    * New command ns_filestat which is similar to file stat but uses direct system 
      call instead of Tcl VFS

    * New command ns_db rowcount, which return the number of affected rows after a
      DML operation.

    * Support for If-Range: header in conditional range requests, this makes the server
      more RFC compliant and allows file retrievals, re-gets and file mirroring without 
      additional coding, it is all done by the server and HTTP

Security Improvements:
    * Disallow terminal escape characters in the log file (potential attack)
    * Protection against path traversal attack

Bug Fixes:
    * Fixed timeout keep-alive management: When many requests were
      posted into a persistent connection, it happend frequently that
      a few of these requests were processed after the keep-alive
      timeout (keepwait) was firing.

    * Fixed various potential crashes (range requests, severity
      management, 64 bit, NsTclParseArgsObjCmd with Tcl 8.5, POST with
      sizes ending exactly at page boundary, accessing "nsconn
      content" after connection close, purges on new-created entries
      in the cache).

    * Improved test environment: 
      - placed nstest into a namespace
      - added parameter "-verbose" to nstest::http to trace communication 
      - added parameter -omitcontentlength to to nstest::http to test
        requests without content length

    * Fixed early closes from the server on too-large content (looked like
      a server crash to clients like firefox, google chrome, etc.). This
      has the disadvantage that now the full request has to be transferred.

    * Naviserver could loop under linux in some situations where a
      client connection was closed unexpectedly (observed under vmware
      under intel 64bit).

    * Improved Code quality (reduced scope of variables, unused variables, 
      changed types of file descriptors for socket from "int" to "SOCKET"
      etc.).

    * removed unused config parameter "urlstats", "maxurlstats",
      "globalstats", "maxdropped", "keepallmethods"

    * Fix to prevent multiple DriverAccepts on the same socket. The
      original coded relied on the fact that later accepts lead to an
      ERROR_STATE. Under RHEL 4 (Power, 64bit) the second accept
      blocks.

    * Fix Ns_Time for platforms, where time_t is long.
    * Updated documentation
    * Various 64bit fixes.
    * Fix path attribute of HTP Cookie string.
    * Make sure upload stats lock is unlocked after use.
    * Fix crash in writer thread logging already freed data.
    * Fix crashes in cache code due to incorrect expired entry flushing fixed.
    * Only add cache commands to virtual server interps.
    * Don't inflate flush-stats on cache eval error.
    * Custom error documents (return redirects) now send back the correct HTTP
    * response code. Used to always report 200, success.
    * Make unsetting an environment variable work cross platform.
    * Fix bug where executable name was freed before use.
    * Don't delete bound Unix domain sockets.
    * Fix typo in ns_setexpires command.
    * Windows: block SIGPIPE.
    * Windows: fix stdin, stdout, stderr channel initialization.
    * Fix infinite loop in spooler thread code.
    * Message line-breaking of email bodies sent with ns_sendmail now works
      correctly for non ASCII data.
    * Files over 2 Gb are supported for logging, serving, uploads, etc.
    * Fixed ns_sendmail for cases when message body is large and it fails to
      send all body because of nonblocking socket mode
    * Fix a race condition in the fastpath code which could allow random files
      anywhere on the same filesystem to be served by the server.


Incompatible API Changes:

    * ns_setcookie -maxage renamed -expires to match common usage throughout
      code.

    * All cookies are now set HttpOnly by default. The -scriptable option must
      be true for the client javascript engine to have access to the cookies.

    * The 'secure' flag of Ns_ConnSetCookieEx() is now a flags option which
      takes NS_COOKIE_SECURE and NS_COOKIE_SCRIPTABLE. Non-scriptable is the
      default as for the Tcl API.

    * ns_var, ns_share and the -share option to ns_set have been removed.
      Please use the nsv_* commands instead.


Configuration Changes:

    Please update your server configuration files to take account of the
    following new features and changes.

    * Randomizing the connection life-time controlling parameters
      "connsperthread" and "threadtimeout" by a new config parameter
      "spread". The spread is a number between 0 and 100, expressing
      the percentage of randomization. The randomization provides
      better resource distributions and prohibits mass thread
      extinction and recreations.

    * New config parameters "keepalivemaxuploadsize" and
      "keepalivemaxdownloadsize" for controlling keep-alives for largish
      content. Use separate request instead of waiting until the large
      content transfer has finished.

    * Fastpath static page configuration is now a global setting rather then
      per-server:

      ns_section "ns/fastpath"
      ns_param mmap          false    ;# Use mmap(2) to read files from disk.
      ns_param cache         false    ;# Cache file contents in memory.
      ns_param cachemaxsize  10240000 ;# Size of file cache, if enabled.
      ns_param cachemaxentry 8192     ;# Don't cache files larger than this.

    * Global thread stacksize configuration deprecated. Server now uses OS
      default. Only explicitly set the stacksize to some smaller than default
      value if you need to save memory because your server has a lot of
      threads, and you know for certain this won't cause problems with deeply
      nested Tcl or ADP scripts.

      ns_section "ns/parameters"      ;# or "ns/threads"
      ns_param stacksize     100000   ;# DON'T DO THIS.

    * The dnscachemaxentries config param has been renamed dnscachemaxsize to
      more accurately reflect what the setting does. A new setting
      dnswaittimeout has been added:

      ns_section "ns/parameters"
      ns_param dnscache        true   ;# Enable the DNS query cache.
      ns_param dnscachemaxsize 512000 ;# Max memory for cache.
      ns_param dnscachetimeout 60     ;# Minutes to cache a DNS query.
      ns_param dnstimeout      5      ;# Seconds to wait for query answer.

    * The buffer size used by the writer thread is now configurable:

      ns_section "ns/server/server1/module/nssock"
      ns_param writerbufsize   8192   ;# Read from file in bufsize chunks.

    * The Tcl lazy loader may be enabled with the following parameter:

      ns_section "ns/server/server1/tcl"
      ns_param lazyloader      false  ;# Define procs in thread-interps on
      demand.

    * New sections for server limits:

      ns_section "ns/limits"
      ns_param default         "Default Limits" ;# Defines a limit.

      ns_section "ns/limit/default"
      ns_param maxrun          100       ;# Conn threads running for limit.
      ns_param maxwait         100       ;# Conn threads waiting for limit.
      ns_param maxupload       102400000 ;# Max size of file upload in bytes.
      ns_param timeout         60        ;# Total seconds to wait for resources.

      ns_section "ns/server/server1/limits"
      ns_param default         "GET  /*" ;# Map default limit to URL.
      ns_param default         "POST /*"
      ns_param default         "HEAD /*"


Code Changes:

   * Fixed test to use preferred getaddrinfo()/getnameinfo() for Mac
     OS X instead of gethostbyaddr()/gethostbyname() when working
     under the OS release.

   * Make compilation clean under clang.

   * Provide names for Ns_Mutex to report meaningful output in
     naviserver statistics.

   * Use poll() as well under Darwin. Per default, poll() returns
     writeable even when the socket is not. However, setting
     SO_SNDLOWAT fixes this (added by this patch). The change makes it
     possible to quer POLLHUP for all platforms.

   * Use "long" instead of "int" for statistics to avoid quick overruns.

   * Added private version of NsBsearch and re-define the "bsearch" to
     point to it for Windows builds. The Windows implementation of
     bsearch appears to be buggy.

    * Rewritten cancellation logic. Cancelled jobs stay in the queue
      and get run on the thread as any other jobs. The differnce is
      only that we mark the cancellation state early (even before
      running the script) so the very first Tcl command in the script
      will be cancelled thus resulting in whole job cancellation. This
      fixes some weird races.

   * Nsv shared variables now have a C API.

   * Experimental event driven IO API, Ns_Event*().

   * New Ns_RegisterAtShutdown() proc handles notification of shutdown and
     wait for completion with timeout.

   * Make Ns_RegisterProxy() public, add ns_register_proxy command.

   * Vectored IO support:

       Ns_ConnSend() now sends all given buffers. Used to send 16 and silently
       discard the rest.

       Increase max iov buffs sent at once.

       Expose iov functionality to higher layers with Ns_ConnWriteVChars(),
       which handles character data, and Ns_ConnWriteV(), which manages data
       streaming.

       ns_write now takes a vector of buffers.

   * New driver callback API. This affects modules such as nssock and any SSL
     modules. This provides more flexibility to write unusual protocol modules.
     Also added is the ability to provide platform-specific sendfile() support.

   * Each loaded driver module now runs in it's own thread (port from
     AOLserver 4.5).

   * Use *DStingSetLength() rather than *DStringTrunc() throughout code to try
     and prevent excess malloc/free activity.

   * Conn structure now contains stat with the file currently being served, stat is
     called at the beginning of the request

   The following routines have been removed, deprecated or disabled.

   * Removed: Ns_RegisterServerShutdown(), Ns_RegisterAtServerShutdown(),
     Ns_RegisterShutdown().
     See: Ns_RegisterAtShutdown().
   * Disabled: Ns_LogSetLogFlushProc(), Ns_SetNsLogProc().
     See: Ns_AddLogfilter(), Ns_RemoveLofFilter().


   IMPORTANT API changes: (length, nsend) parameters are now Tcl_WideInt, so it requires
   to recompile all modules that use those functions:
        
        int Ns_ConnSendChannel(Ns_Conn *conn, Tcl_Channel chan, Tcl_WideInt nsend)
        int Ns_ConnSendFp(Ns_Conn *conn, FILE *fp, Tcl_WideInt nsend)
        int Ns_ConnSendFd(Ns_Conn *conn, int fd, Tcl_WideInt nsend)
        
        void Ns_ConnSetRequiredHeaders(Ns_Conn *conn, CONST char *type, Tcl_WideInt length)
        void Ns_ConnSetLengthHeader(Ns_Conn *conn, Tcl_WideInt length)
        int Ns_ConnReturnOpenChannel(Ns_Conn *conn, int status, CONST char *type,
                         Tcl_Channel chan, Tcl_WideInt length)
        int Ns_ConnReturnOpenFile(Ns_Conn *conn, int status, CONST char *type,
                      FILE *fp, Tcl_WideInt length)
        int Ns_ConnReturnOpenFd(Ns_Conn *conn, int status, CONST char *type,
                    int fd, Tcl_WideInt length)


======================================
NaviServer 4.99.1, released 2006-01-02
======================================

This is just a part of numerous additions, improvements and
fixes since 4.99.0 release. For the complete set, please consult
the ChangeLog file.

New Features:

    * HTTP Range requests for streaming media and resuming downloads 
    * Full Chunked encoding support for Fastpath, Adp and Tcl scripts
    * Using temporary files for large uploads when content exceeds 
      pre-configured maxsize parameter
    * New spooler thread for handling large file uploads
    * New [ns_upload_stats] command to gather upload statistics
    * New spooler thread for handling large file uploads
    * Added ns_conn responseversion to manually set response protocol
      and version to have full control about returned HTTP format
    * Add C-level support for TclVFS (all IO on files done with Tcl wrappers)
    * Add new command [ns_atprestartup].
    * Add new command [ns_runonce] which ensures that the given script is
      run only once, either globally or per virtual server, during the 
      lifetime of the server process.
    * New autogen/TEA3 compatible configuration
    * Add new command [ns_logctl severity]
    * Added many new test (this is an evolving effort)
    * Added support of binder as a separate process
    * Added [ns_info started] and [ns_info shutdownpending] commands
    * Add new Tcl command [ns_register_fastpath]
    * Added Tcl interface to C-level cache routines.
    * Added first traces of documentation based on Tcl doctools
    * New simplified deployment directory structure

Code Changes:

    * New function Ns_ConnPrintfHeaders() for adding NTTP headers in
      printf style
    * Allocate interps efficiently, max 1 per-thread per-server
    * Add Ns_TclLogErrorInfo and allow admin to configure which 
      connection headers to log for Tcl errors
    * Remove [ns_markfordelete] command and roll into ns_ictl as
      [ns_ictl markfordelete]
    * Make Tcl send panic messages to the server log.

======================================
NaviServer 4.99.0, released 2005-07-05
======================================

New Features:

    * Byte code for Tcl pages are cached if nscache module present
    * Add support for mass virtual hosting #1159471
    * ns_uuencode et all now do full base64 encoding
    * New introspection commands for procs, filters and traces #1161597
    * C and Tcl API for HTTP cookies #1145957
    * Add -bytes option to ns_conncptofp command
    * New command ns_conn channel #1156141
    * Add new watchdog feature to restart the server if it crashes
    * Add ns_sha1 cryptographic hash command
    * C and Tcl API for setting response code of current connection
    * ns_accesslog can change configuration at runtime
    * New C and Tcl API for parsing command options and arguments
    * Server can now run as root if instructed to
    * Add new command ns_atstartup
    * New routines for listening on UDP and UNIX domain sockets
    * Add -localhost -localport options to ns_sockopen

Bug Fixes:

    * Add locking to non multi-thread safe timegm()
    * Fix infinite loop in DNS routines
    * Call comm drivers DriverClose command when socket is released
    * Fix crash bug in nslog on NULL rollfmt
    * Fix URL decoding of '+' characters #1145277
    * Report correct MIME type for xml documents #1145927
    * Fix crash in channel detach code #1143586
    * Make ns_sendmail handle dropped connections
    * Fix crash on startup when resolving localhost
    * Preserve nsdb exception messages generated by driver

Code Changes:

    * New function Ns_ConnPrintfHeaders()
    * Use GCC compiler code checks #1215725
    * Remove GNU implementations of getopt and poll
    * Cleanup up autoconf and use autoheader
    * Clean up test harness and add lots of tests
    * New Tcl callback infrastructure #1162223
    * New convenience functions for handling Tcl object types
    * New function Ns_TclPrintfResult() for formatting Tcl results
    * No more support for defunct AOLpress
    * Remove support for old connid argument in much code #1156107
    * Modules nspd and nsext moved from core to external modules
    * Objectified TclX keyed lists
