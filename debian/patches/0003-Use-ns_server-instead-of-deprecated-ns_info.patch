From: David Osborne <david@qcode.co.uk>
Date: Mon, 27 May 2013 16:47:08 +0100
Subject: [PATCH] Use ns_server instead of deprecated ns_info

---
 debian/patches/0001-add-rpath.patch                |    2 +-
 .../patches/0003-Patch-bitbucket-install.tcl.patch |   34 --------------------
 debian/patches/series                              |    2 +-
 index.adp                                          |    8 ++--
 4 files changed, 6 insertions(+), 40 deletions(-)
 delete mode 100644 debian/patches/0003-Patch-bitbucket-install.tcl.patch

diff --git a/debian/patches/0001-add-rpath.patch b/debian/patches/0001-add-rpath.patch
index 6d62eb5..1636707 100644
--- a/debian/patches/0001-add-rpath.patch
+++ b/debian/patches/0001-add-rpath.patch
@@ -9,7 +9,7 @@ Add naviserver lib dir to executable RPATH
  2 files changed, 17 insertions(+), 15 deletions(-)
 
 diff --git a/include/Makefile.global.in b/include/Makefile.global.in
-index fe7ce6c..9423a1c 100644
+index 97e500c..9e18fe0 100644
 --- a/include/Makefile.global.in
 +++ b/include/Makefile.global.in
 @@ -40,6 +40,18 @@
diff --git a/debian/patches/0003-Patch-bitbucket-install.tcl.patch b/debian/patches/0003-Patch-bitbucket-install.tcl.patch
deleted file mode 100644
index 6e80675..0000000
--- a/debian/patches/0003-Patch-bitbucket-install.tcl.patch
+++ /dev/null
@@ -1,34 +0,0 @@
-From: David Osborne <david@qcode.co.uk>
-Date: Fri, 3 May 2013 14:59:55 +0100
-Subject: [PATCH] Patch bitbucket-install.tcl to work here
-
----
- bitbucket-install.tcl |    9 +++++----
- 1 files changed, 5 insertions(+), 4 deletions(-)
-
-diff --git a/bitbucket-install.tcl b/bitbucket-install.tcl
-index c246c44..9389b34 100644
---- a/bitbucket-install.tcl
-+++ b/bitbucket-install.tcl
-@@ -3,11 +3,11 @@ switch -exact $pageName {
-   nsconf.tcl -
-   nsstats.tcl {
-     set source https://bitbucket.org/naviserver/[file root $pageName]/get/tip.tar.gz
--    set page /opt/local/ns/pages/$pageName
-+    set page /usr/share/doc/naviserver/$pageName
-     if {![file readable $page]} {
--      exec wget --quiet --no-check-certificate -O /tmp/nsstats.tar.gz $source
--      if {[catch {exec tar Ozxvf /tmp/nsstats.tar.gz *$pageName > $page} errorMsg]} {
--	if {[lindex $errorMsg 0] ne "x"} {
-+      exec wget --quiet --no-check-certificate -O /tmp/[file root $pageName].tar.gz $source
-+      if {[catch {exec tar --wildcards -Ozxvf /tmp/[file root $pageName].tar.gz *$pageName > $page} errorMsg]} {
-+	if { ![regexp -line "^naviserver\.+/${pageName}\$" [lindex [split $errorMsg] 0]] } {
- 	  ns_log notice "error: $errorMsg"
- 	  ns_return 200 text/html \
- 	      "<html><body>error while downloading $pageName: <b>$errorMsg</b>. <a href='/'>return</a>" 
-@@ -28,3 +28,4 @@ switch -exact $pageName {
- 
- 
- 
-+
--- 
diff --git a/debian/patches/series b/debian/patches/series
index bb31a41..a76a9cb 100644
--- a/debian/patches/series
+++ b/debian/patches/series
@@ -1,2 +1,2 @@
 0001-add-rpath.patch
-0003-Patch-bitbucket-install.tcl.patch
+0002-Patch-bitbucket-install.tcl-to-work-here.patch
diff --git a/index.adp b/index.adp
index 2684b0d..c4ac8ce 100644
--- a/index.adp
+++ b/index.adp
@@ -44,9 +44,9 @@
    ns_adp_puts {<li>The Naviserver <a href="nsstats.tcl">Statistics page</a> can be
                     useful in resolving performance issues.}
 
-   if { ![file exists [ns_info pageroot]/nsstats.tcl] } {
+   if { ![file exists [ns_server pagedir]/nsstats.tcl] } {
      ns_adp_puts [subst {<br><i>Currently nsstats is not installed as
-                     [ns_info pageroot]/nsstats.tcl, to install you need to
+                     [ns_server pagedir]/nsstats.tcl, to install you need to
                      download modules and do make install in nsstats
                      directory. <a href = 'bitbucket-install.tcl?file=nsstats.tcl'>Install now</a>.
                      </i>}]
@@ -57,13 +57,13 @@
   <li>The Naviserver runtime <a href="nsconf.tcl">Config page</a> can be
     useful in reviewing server's setup.<br>
   <%
-   if { ![file exists [ns_info pageroot]/nsconf.tcl] } {
+   if { ![file exists [ns_server pagedir]/nsconf.tcl] } {
      ns_adp_puts [subst {<i>Currently nsconf is not installed yet.
 	<a href = 'bitbucket-install.tcl?file=nsconf.tcl'>Install now</a>.</i>
     }]
    } else {
     ns_adp_puts [subst {The nsconf module has to be enabled and protected by a password in
-    <strong>[ns_info pageroot]/nsconf.tcl</strong>.}]
+    <strong>[ns_server pagedir]/nsconf.tcl</strong>.}]
     }
     %>
     <p>
-- 
