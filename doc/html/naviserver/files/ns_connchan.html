
<!DOCTYPE html><html><head>
<title>ns_connchan - NaviServer Built-in Commands</title>
<link rel="stylesheet" href="../man.css" type="text/css">
</head>
<!-- Generated from file 'ns_connchan.man' by tcllib/doctools with format 'html'
   -->
<!-- ns_connchan.n
   -->
<body><div id="man-header">
  <a href="http://wiki.tcl.tk/2090"><span class="logo">&nbsp;</span><strong>NaviServer</strong></a>
  - programmable web server
</div>
 <hr> [
   <a href="../../toc.html">Main Table Of Contents</a>
| <a href="../toc.html">Table Of Contents</a>
| <a href="../../index.html">Keyword Index</a>
 ] <hr>
<div class="doctools">
<h1 class="doctools_title">ns_connchan(n) 4.99.19 naviserver &quot;NaviServer Built-in Commands&quot;</h1>
<div id="name" class="doctools_section"><h2><a name="name">Name</a></h2>
<p>ns_connchan - Manage connection channels.</p>
</div>
<div id="toc" class="doctools_section"><h2><a name="toc">Table Of Contents</a></h2>
<ul class="doctools_toc">
<li class="doctools_section"><a href="#toc">Table Of Contents</a></li>
<li class="doctools_section"><a href="#synopsis">Synopsis</a></li>
<li class="doctools_section"><a href="#section1">Description</a></li>
<li class="doctools_section"><a href="#section2">COMMANDS</a></li>
<li class="doctools_section"><a href="#see-also">See Also</a></li>
<li class="doctools_section"><a href="#keywords">Keywords</a></li>
</ul>
</div>
<div id="synopsis" class="doctools_section"><h2><a name="synopsis">Synopsis</a></h2>
<div class="doctools_synopsis">
<ul class="doctools_syntax">
<li><a href="#1"><b class="cmd">ns_connchan detach</b></a></li>
<li><a href="#2"><b class="cmd">ns_connchan close</b> <i class="arg">channel</i></a></li>
<li><a href="#3"><b class="cmd">ns_connchan exists</b> <i class="arg">channel</i></a></li>
<li><a href="#4"><b class="cmd">ns_connchan list</b> <span class="opt">?<b class="option">-server <i class="arg">server</i></b>?</span></a></li>
<li><a href="#5"><b class="cmd">ns_connchan callback</b> <span class="opt">?<b class="option">-timeout <i class="arg">t</i></b>?</span> <span class="opt">?<b class="option">-receivetimeout <i class="arg">r</i></b>?</span> <span class="opt">?<b class="option">-sendtimeout <i class="arg">s</i></b>?</span> <i class="arg">channel</i> <i class="arg">command</i> <i class="arg">when</i></a></li>
<li><a href="#6"><b class="cmd">ns_connchan listen</b> <span class="opt">?<b class="option">-driver <i class="arg">d</i></b>?</span> <span class="opt">?<b class="option">-server <i class="arg">s</i></b>?</span> <span class="opt">?<b class="option">-bind]</b>?</span> <i class="arg">address</i> <i class="arg">port</i> <i class="arg">script</i></a></li>
<li><a href="#7"><b class="cmd">ns_connchan open</b> <span class="opt">?<b class="option">-headers <i class="arg">h</i></b>?</span> <span class="opt">?<b class="option">-method <i class="arg">m</i></b>?</span> <span class="opt">?<b class="option">-timeout <i class="arg">t</i></b>?</span> <span class="opt">?<b class="option">-version <i class="arg">v</i></b>?</span> <i class="arg">url</i></a></li>
<li><a href="#8"><b class="cmd">ns_connchan read</b> <i class="arg">channel</i></a></li>
<li><a href="#9"><b class="cmd">ns_connchan write</b> <i class="arg">channel</i> <i class="arg">string</i> 	</a></li>
</ul>
</div>
</div>
<div id="section1" class="doctools_section"><h2><a name="section1">Description</a></h2>
<p>The command <b class="cmd">ns_connchan</b> allows one to detach the
 current channel from a connection thread and manage the connection
 outside the initiating connection thread. It allows one to write or read
 to the channel, to define callbacks and to list open connections and
 to close the connection. The read and write operations on this
 channel will use directly the driver infrastructure which was in use
 during the detach command.</p>
<p>The command allows e.g. to read from and to write to all
 network drivers (such as plain HTTP channels and from SSL/TLS
 connections). It can be used to implement e.g. WebSockets or
 asynchronous deliveries (e.g. h264 streams) including secure
 connections. Therefore, this command is more general than the
 approaches based on <b class="cmd">ns_conn channel</b> using plain Tcl channels.</p>
<p>NaviServer maintains an internal table per server to keep track of
 the detached connection channels and to offer introspection to the
 state of the detached channels.</p>
</div>
<div id="section2" class="doctools_section"><h2><a name="section2">COMMANDS</a></h2>
<dl class="doctools_definitions">
<dt><a name="1"><b class="cmd">ns_connchan detach</b></a></dt>
<dd><p>The command <b class="cmd">ns_connchan detach</b> unplugs the connection channel from
 the current connection thread and stores it with a fresh handle name
 in a per-virtual-server private table. The command returns the
 created handle as result.</p>
<p>After this command was issued in a connection thread all attempts to
 access the connection socket directly (e.g. via <b class="cmd"><a href="ns_write.html">ns_write</a></b>) will fail.</p></dd>
<dt><a name="2"><b class="cmd">ns_connchan close</b> <i class="arg">channel</i></a></dt>
<dd><p>Close the named connection channel.</p></dd>
<dt><a name="3"><b class="cmd">ns_connchan exists</b> <i class="arg">channel</i></a></dt>
<dd><p>Returns 1 if the named connection channel exists, 0 otherwise.</p></dd>
<dt><a name="4"><b class="cmd">ns_connchan list</b> <span class="opt">?<b class="option">-server <i class="arg">server</i></b>?</span></a></dt>
<dd><p>Return a list of the currently detached connection channels for the
  current or named <i class="arg">server</i>.</p>
<p>Every list entry contains</p>
<ul class="doctools_itemized">
	
<li><p>name of the channel</p></li>
<li><p>name of the thread</p></li>
<li><p>start time of the initiating request,</p></li>
<li><p>driver,</p></li>
<li><p>the ip-address of the requestor,</p></li>
<li><p>sent bytes,</p></li>
<li><p>received bytes,</p></li>
<li><p>the client data as provided via [ns_conn
               clientdata],</p></li>
<li><p>the cmd name of the callback, or &quot;&quot; when no callback is registered,</p></li>
<li><p>the callback condition flags, or &quot;&quot; when no callback is registered.</p></li>
</ul></dd>
<dt><a name="5"><b class="cmd">ns_connchan callback</b> <span class="opt">?<b class="option">-timeout <i class="arg">t</i></b>?</span> <span class="opt">?<b class="option">-receivetimeout <i class="arg">r</i></b>?</span> <span class="opt">?<b class="option">-sendtimeout <i class="arg">s</i></b>?</span> <i class="arg">channel</i> <i class="arg">command</i> <i class="arg">when</i></a></dt>
<dd><p>Register a Tcl callback for the names connection <i class="arg">channel</i>.
<b class="option">-timeout</b> is the poll timeout, <b class="option">-receivetimeout</b> is a
timeout for incoming packets, <b class="option">-sendtimeout</b> is the timeout for
outgoing packets.  When <b class="option">-sendtimeout</b> has the value of 0, a
read operation might return the empty string. A value larger than 0
might block the event processing for the specified time.</p>
<p>The argument <i class="arg">when</i> consist of one or more characters
of r, w, e, or x, specifying, when the callback should fire.
All timeouts are specified in the form <i class="arg">secs<span class="opt">?:microsecs?</span></i> or
<i class="arg">secs.fraction</i>.</p>
<p>When the callback is fired, the specified Tcl command will be
called with an additional argument, which is an indicator for the
reason of the call <i class="arg">when</i>. The value of <i class="arg">when</i> will be as
follows:</p>
<ul class="doctools_itemized">
<li><p>r - the socket is readable</p></li>
<li><p>w - the socket is writable</p></li>
<li><p>e - the socket has an exceptional condition</p></li>
<li><p>x - the server is shutting down</p></li>
<li><p>t - timeout received</p></li>
</ul>
<p>When the callback exits, its return value determines, whether
the callback should be canceled or not. The return value is
interpreted as follows:</p>
<ul class="doctools_itemized">
<li><p>0 - the callback is canceled, and the channel is deleted
           automatically (typically, when an error occurs)</p></li>
<li><p>1 - the callback will be used as well for further events</p></li>
<li><p>2 - the callback will be suspended. No further events will
           be fired, but the channel is not deleted.</p></li>
</ul></dd>
<dt><a name="6"><b class="cmd">ns_connchan listen</b> <span class="opt">?<b class="option">-driver <i class="arg">d</i></b>?</span> <span class="opt">?<b class="option">-server <i class="arg">s</i></b>?</span> <span class="opt">?<b class="option">-bind]</b>?</span> <i class="arg">address</i> <i class="arg">port</i> <i class="arg">script</i></a></dt>
<dd><p>Open listening socket. Call the <i class="arg">script</i> callback on incoming
connections. On success, this command returns a dict containing
&quot;channel&quot;, &quot;port&quot;, &quot;sock&quot; and &quot;address&quot;.</p></dd>
<dt><a name="7"><b class="cmd">ns_connchan open</b> <span class="opt">?<b class="option">-headers <i class="arg">h</i></b>?</span> <span class="opt">?<b class="option">-method <i class="arg">m</i></b>?</span> <span class="opt">?<b class="option">-timeout <i class="arg">t</i></b>?</span> <span class="opt">?<b class="option">-version <i class="arg">v</i></b>?</span> <i class="arg">url</i></a></dt>
<dd><p>Open a connection channel to the specified <i class="arg">url</i>.
The URL might be an HTTP or an HTTPS URL.
<b class="option">-headers</b> refers to a <i class="term"><a href="../../index.html#key0">ns_set</a></i> of request header fields,
<b class="option">-method</b> is the HTTP method (default GET),
<b class="option">-timeout</b> is the timeout for establishing the connection
(default 1 second), and
<b class="option">-version</b> specifies the HTTP version (default 1.0)</p></dd>
<dt><a name="8"><b class="cmd">ns_connchan read</b> <i class="arg">channel</i></a></dt>
<dd><p>Read from the specified connection channel.</p></dd>
<dt><a name="9"><b class="cmd">ns_connchan write</b> <i class="arg">channel</i> <i class="arg">string</i> 	</a></dt>
<dd><p>Write to the specified connection channel. The function returns
the number of bytes sent, which might be less than the input length.</p></dd>
</dl>
</div>
<div id="see-also" class="doctools_section"><h2><a name="see-also">See Also</a></h2>
<p><a href="ns_chan.html">ns_chan</a>, <a href="ns_conn.html">ns_conn</a>, <a href="ns_sockcallback.html">ns_sockcallback</a>, <a href="ns_write.html">ns_write</a></p>
</div>
<div id="keywords" class="doctools_section"><h2><a name="keywords">Keywords</a></h2>
<p><a href="../../index.html#key138">channels</a>, <a href="../../index.html#key18">driver</a>, <a href="../../index.html#key34">server built-in</a>, <a href="../../index.html#key38">socket</a></p>
</div>
<div id="man-footer">
  
</div>
</div></body></html>
